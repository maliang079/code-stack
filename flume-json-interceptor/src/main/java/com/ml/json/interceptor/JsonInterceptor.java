package com.ml.json.interceptor;

import java.nio.charset.Charset;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import com.alibaba.fastjson.JSONObject;

import org.apache.flume.Event;
import org.apache.flume.event.EventBuilder;
import org.apache.flume.interceptor.Interceptor;

public class JsonInterceptor implements Interceptor {

    private String jsonFormat = null;
    private String jsonProp = null;

    public JsonInterceptor(String jsonFormat, String jsonProp) {
        this.jsonFormat = jsonFormat;
        this.jsonProp = jsonProp;
    }

    @Override
    public void initialize() {

    }

    @Override
    public Event intercept(Event event) {
        String originBody = new String(event.getBody(), Charset.forName("UTF-8"));
        JSONObject json = JSONObject.parseObject(jsonFormat);
        json.put(jsonProp, originBody);
        String body = json.toJSONString();
        return EventBuilder.withBody(body.getBytes(Charset.forName("UTF-8")), event.getHeaders());
    }

    @Override
    public List<Event> intercept(List<Event> events) {
        return Optional.ofNullable(events).orElseGet(Collections::emptyList).stream().map(event -> intercept(event)).collect(Collectors.toList());
    }

    @Override
    public void close() {

    }

    public static void main(String[] args) {
        String str = "{\"message\":\"\", \"type\":\"dbus_log\", \"host\":\"kafka_sec_cibp\"}";
        JSONObject json = JSONObject.parseObject(str);
        json.put("message", "2019-12-30 20:24:45,931 [http-nio-9000-exec-8] [INFO] c.c.loanplatform.channel.info.collect.common.component.util.UserCancelLogUtil 12 - 数据库来源：CIBP合同，数据信息：{\"contractItem\":[{\"item\":\"收入流水核实\",\"itemContent\":\"[{\\\"code\\\": \\\"3\\\", \\\"optionName\\\": \\\"柜面网点核实\\\"}]\",\"createTime\":1560173688000,\"contractId\":\"10028498281\",\"id\":8659281,\"type\":\"B\",\"confirmType\":\"3\",\"operatorId\":\"111111111111\",\"operator\":\"王芳\"},{\"item\":\"合同签订\",\"createTime\":1560173688000,\"contractId\":\"10028498281\",\"id\":8659813,\"type\":\"G\",\"operatorId\":\"111111111111\",\"operator\":\"王芳\"},{\"item\":\"征信核实\",\"itemContent\":\"[{\\\"code\\\": \\\"4\\\", \\\"optionName\\\": \\\"合作方核实\\\"}]\",\"createTime\":1560173688000,\"contractId\":\"10028498281\",\"id\":8677517,\"type\":\"A\",\"confirmType\":\"4\",\"operatorId\":\"111111111111\",\"operator\":\"王芳\"}],\"contractOperation\":[{\"node\":\"4200\",\"orderId\":\"33202217\",\"createTime\":1560177801000,\"contractId\":\"10028498281\",\"id\":15501271,\"event\":\"合同签订\",\"operatorId\":\"11011728\",\"channelId\":\"100\",\"operator\":\"综合信贷管理员\"},{\"node\":\"4100\",\"orderId\":\"33202217\",\"createTime\":1560177254000,\"contractId\":\"10028498281\",\"id\":15501267,\"event\":\"合同签订\",\"operatorId\":\"11011728\",\"channelId\":\"100\",\"operator\":\"综合信贷管理员\"},{\"node\":\"4100\",\"orderId\":\"33202217\",\"createTime\":1560174787000,\"contractId\":\"10028498281\",\"id\":15501275,\"event\":\"合同签订\",\"operatorId\":\"11011728\",\"channelId\":\"100\",\"operator\":\"综合信贷管理员\"},{\"node\":\"4200\",\"orderId\":\"33202217\",\"createTime\":1560174775000,\"contractId\":\"10028498281\",\"id\":15501277,\"event\":\"合同签订\",\"operatorId\":\"11011728\",\"channelId\":\"100\",\"operator\":\"综合信贷管理员\"},{\"node\":\"4200\",\"orderId\":\"33202217\",\"createTime\":1560173729000,\"contractId\":\"10028498281\",\"id\":15501273,\"event\":\"合同签订\",\"operatorId\":\"11011728\",\"channelId\":\"100\",\"operator\":\"综合信贷管理员\"},{\"node\":\"4100\",\"orderId\":\"33202217\",\"createTime\":1560173555000,\"contractId\":\"10028498281\",\"id\":15501265,\"event\":\"合同签订\",\"operatorId\":\"11011728\",\"channelId\":\"100\",\"operator\":\"综合信贷管理员\"},{\"node\":\"4000\",\"orderId\":\"33202217\",\"createTime\":1560170291000,\"contractId\":\"10028498281\",\"id\":15501269,\"event\":\"通知签约下一步\",\"operatorId\":\"11011728\",\"channelId\":\"100\",\"operator\":\"综合信贷管理员\"}],\"contractFlow\":[{\"orderId\":\"33202217\",\"createTime\":1560177818000,\"contractId\":\"10028498281\",\"id\":61497067,\"curStatus\":\"9001\",\"event\":\"上传合同资料完成\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560177818000,\"contractId\":\"10028498281\",\"id\":61497069,\"curStatus\":\"4200\",\"event\":\"客户放弃\",\"operatorId\":\"11011728.00000000000\",\"content\":\"提前还款费率过高\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560177807000,\"contractId\":\"10028498281\",\"id\":61497071,\"curStatus\":\"4200\",\"event\":\"查询三方签约结果失败\"},{\"orderId\":\"33202217\",\"createTime\":1560177801000,\"contractId\":\"10028498281\",\"id\":61497073,\"curStatus\":\"4200\",\"event\":\"合同签订\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560177254000,\"contractId\":\"10028498281\",\"id\":61497075,\"curStatus\":\"4100\",\"event\":\"合同签订\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560174809000,\"contractId\":\"10028498281\",\"id\":61497077,\"curStatus\":\"4200\",\"event\":\"客户放弃\",\"operatorId\":\"11011728.00000000000\",\"content\":\"还款费率过高\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560174798000,\"contractId\":\"10028498281\",\"id\":61497079,\"curStatus\":\"4200\",\"event\":\"客户放弃\",\"operatorId\":\"11011728.00000000000\",\"content\":\"签约原件不符合大纲要求\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560174793000,\"contractId\":\"10028498281\",\"id\":61497081,\"curStatus\":\"4200\",\"event\":\"客户放弃\",\"operatorId\":\"11011728.00000000000\",\"content\":\"客户已无资金需求\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560174787000,\"contractId\":\"10028498281\",\"id\":61497083,\"curStatus\":\"4100\",\"event\":\"合同签订\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560174781000,\"contractId\":\"10028498281\",\"id\":61497085,\"curStatus\":\"4200\",\"event\":\"合同签订页面回退\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560174775000,\"contractId\":\"10028498281\",\"id\":61497087,\"curStatus\":\"4200\",\"event\":\"合同签订\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560173864000,\"contractId\":\"10028498281\",\"id\":61497089,\"curStatus\":\"4200\",\"event\":\"电子签约成功\"},{\"orderId\":\"33202217\",\"createTime\":1560173864000,\"contractId\":\"10028498281\",\"id\":61497091,\"curStatus\":\"4200\",\"event\":\"等待上传资料\"},{\"orderId\":\"33202217\",\"createTime\":1560173734000,\"contractId\":\"10028498281\",\"id\":61497093,\"curStatus\":\"4200\",\"event\":\"yrd电子签约\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560173729000,\"contractId\":\"10028498281\",\"id\":61497095,\"curStatus\":\"4200\",\"event\":\"合同签订\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560173676000,\"contractId\":\"10028498281\",\"id\":61497097,\"curStatus\":\"4200\",\"event\":\"宜人贷POS认证成功\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560173675000,\"contractId\":\"10028498281\",\"id\":61497099,\"curStatus\":\"4200\",\"event\":\"宜人贷放款卡鉴权认证成功\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560173658000,\"contractId\":\"10028498281\",\"id\":61497101,\"curStatus\":\"4200\",\"event\":\"查询三方签约结果成功\"},{\"orderId\":\"33202217\",\"createTime\":1560173653000,\"contractId\":\"10028498281\",\"id\":61497103,\"curStatus\":\"4200\",\"event\":\"签约认证成功\"},{\"orderId\":\"33202217\",\"createTime\":1560173634000,\"contractId\":\"10028498281\",\"id\":61497105,\"curStatus\":\"4200\",\"event\":\"获取短信验证码成功\"},{\"orderId\":\"33202217\",\"createTime\":1560173632000,\"contractId\":\"10028498281\",\"id\":61497107,\"curStatus\":\"4200\",\"event\":\"查询三方签约结果成功\"},{\"orderId\":\"33202217\",\"createTime\":1560173626000,\"contractId\":\"10028498281\",\"id\":61497109,\"curStatus\":\"4200\",\"event\":\"签约认证成功\"},{\"orderId\":\"33202217\",\"createTime\":1560173610000,\"contractId\":\"10028498281\",\"id\":61497111,\"curStatus\":\"4200\",\"event\":\"获取短信验证码成功\"},{\"orderId\":\"33202217\",\"createTime\":1560173608000,\"contractId\":\"10028498281\",\"id\":61497113,\"curStatus\":\"4200\",\"event\":\"查询三方签约结果成功\"},{\"orderId\":\"33202217\",\"createTime\":1560173555000,\"contractId\":\"10028498281\",\"id\":61497115,\"curStatus\":\"4100\",\"event\":\"合同签订\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560170291000,\"contractId\":\"10028498281\",\"id\":61497117,\"curStatus\":\"4000\",\"event\":\"通知签约下一步\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560170289000,\"contractId\":\"10028498281\",\"id\":61497119,\"curStatus\":\"4000\",\"event\":\"编辑短信\",\"operatorId\":\"11011728.00000000000\",\"operator\":\"综合信贷管理员\"},{\"orderId\":\"33202217\",\"createTime\":1560165551000,\"contractId\":\"10028498281\",\"id\":61497121,\"curStatus\":\"4000\",\"event\":\"新增进件成功\"}],\"orderId\":\"33202217\",\"contractInfo\":{\"clientId\":\"8358236\",\"subproductName\":\"房主贷\",\"operateStatus\":\"1\",\"orderId\":\"33202217\",\"clientName\":\"高娜\",\"signStatus\":\"200\",\"containInsurance\":\"00\",\"yrdUserId\":\"1359810\",\"productName\":\"授薪\",\"repayType\":\"DEBXHK\",\"conditionMet\":\"0\",\"customerType\":\"0\",\"productVersion\":\"11097\",\"subproductId\":\"10\",\"createTime\":1560165551000,\"payMethod\":\"1\",\"contractId\":\"10028498281\",\"signCondition\":\"0\",\"loanPurpose\":\"100\",\"id\":7453265,\"yrdConfirm\":\"1\",\"productType\":\"56\"},\"userCancelTime\":1577708685000,\"orderStatus\":\"9001\",\"contractRate\":{\"stageServiceGuaranteeRate\":0.0,\"insurance\":0,\"periodChargeRate\":0.01,\"orderId\":\"33202217\",\"preServiceGuaranteeRate\":0.03,\"actualAmount\":5000000,\"preServiceGuaranteeCost\":150000,\"yearRate\":0.12,\"contractPeriod\":\"36\",\"preCharge\":0,\"periodCharge\":37746,\"stageServiceGuaranteeCost\":18597,\"monthlyPayment\":227397,\"createTime\":1560165551000,\"preChargeRate\":0.0,\"contractId\":\"10028498281\",\"contractAmount\":5150000,\"id\":7375345},\"contractAccount\":{\"signProvinceName\":\"北京市\",\"payProvinceName\":\"北京市\",\"accountBankCode\":\"11111111111\",\"trustStatus\":\"0\",\"accountMobile\":\"13511082210\",\"orderId\":\"33202217\",\"accountName\":\"高娜\",\"payCityName\":\"北京市\",\"accountBankName\":\"中国工商银行\",\"accountNumber\":\"6226660405239050\",\"idNumber\":\"130984198708271829\",\"payBankName\":\"中国工商银行\",\"signProvinceCode\":\"110000\",\"payCityCode\":\"110100\",\"signCityCode\":\"110100\",\"createTime\":1560165551000,\"identType\":\"1\",\"contractId\":\"10028498281\",\"payProvinceCode\":\"110000\",\"accountCardType\":\"0\",\"id\":7375353,\"signCityName\":\"北京市\"},\"contractMain\":{\"saleId\":\"201403120011\",\"informOperateTime\":1560170291000,\"orderId\":\"33202217\",\"clientName\":\"高娜\",\"departmentId\":\"11116773\",\"groupId\":\"11117586\",\"signStatus\":\"200\",\"clientStatus\":\"0\",\"orderStatus\":\"9001\",\"idNumber\":\"130984198708271829\",\"personalAddress\":\"北京市北京市通州区新华大街34号\",\"conditionMet\":\"0\",\"saleName\":\"田正鑫\",\"subproductId\":\"10\",\"monthlyPayment\":227397,\"subcenterName\":\"北京第二分中心\",\"inUse\":\"1\",\"approvalAmount\":5150000,\"id\":7375317,\"channelId\":\"100\",\"productType\":\"56\",\"enterTime\":1560164105000,\"subcenterId\":\"11183490\",\"departmentName\":\"北京第二分中心第二营业部\",\"trustStatus\":\"0\",\"clientId\":\"8358236\",\"operateStatus\":\"1\",\"saleManagerName\":\"田正鑫\",\"clientEmail\":\"534441366@126.com\",\"actualAmount\":5000000,\"clientLevel\":\"B\",\"departmentCityName\":\"北京市\",\"contractPeriod\":\"36\",\"informOperatorId\":\"11011728\",\"limitInThree\":\"0\",\"phone\":\"13511082210\",\"createTime\":1560165551000,\"companyAddress\":\"北京市北京市朝阳区西大望路1号温特莱中心\",\"saleManagerId\":\"201403120011\",\"contractId\":\"10028498281\",\"signCondition\":\"0\",\"departmentCityId\":\"110100\",\"contractAmount\":5150000,\"informOperator\":\"综合信贷管理员\"}}");
        String body = json.toJSONString();
        System.out.println(body);
    }

    public static class Constants {
        public static final String CONFIG_JSON_FORMAT = "jsonFormat";
        public static final String CONFIG_JSON_PROP_NAME = "jsonProp";
    }

}
